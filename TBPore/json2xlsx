#!/usr/bin/env python3

import sys
import os
import json

# --- Dependency Check Removed ---
# This script now assumes pandas and openpyxl are already installed.

# Try to import pandas, exit if not found.
try:
    import pandas as pd
except ImportError:
    print("❌ Error: The 'pandas' library is not installed.", file=sys.stderr)
    print("Please install it manually: pip install pandas", file=sys.stderr)
    sys.exit(1)

# We also need openpyxl for Excel writing, but pandas will
# raise an error later if it's missing, which is fine.

def print_usage():
    """Prints the correct usage of the script to standard error."""
    print(f"Usage: {sys.argv[0]} <input.json> [--csv]", file=sys.stderr)
    print("  Converts a Mykrobe JSON report to an .xlsx file.", file=sys.stderr)
    print("  --csv: Optionally outputs a .csv file instead.", file=sys.stderr)

def process_mykrobe_json(json_filename):
    """Loads and parses the Mykrobe JSON file."""
    
    # 1. Load the JSON data
    try:
        with open(json_filename, 'r') as f:
            data = json.load(f)
    except FileNotFoundError:
        print(f"❌ Error: The file '{json_filename}' was not found.", file=sys.stderr)
        return None
    except json.JSONDecodeError:
        print(f"❌ Error: Could not decode JSON from '{json_filename}'.", file=sys.stderr)
        return None
    except PermissionError:
        print(f"❌ Error: Permission denied when reading '{json_filename}'.", file=sys.stderr)
        return None

    # 2. Get the main sample ID (e.g., 'SRR35794933')
    try:
        sample_id = list(data.keys())[0]
        susceptibility_data = data[sample_id]['susceptibility']
    except (IndexError, KeyError, TypeError):
        print("❌ Error: JSON structure is not as expected.", file=sys.stderr)
        print("Could not find the main sample key or 'susceptibility' data.", file=sys.stderr)
        return None

    # 3. Process the data
    output_rows = []

    # Iterate through each drug in the susceptibility report
    for drug, details in susceptibility_data.items():
        prediction = details.get('predict', 'Unknown')
        
        mutation_str = ""
        total_confidence = ""  # Default to empty string for susceptible (S) drugs

        # Check if resistance is predicted and 'called_by' data exists
        if prediction == 'R' and 'called_by' in details and details['called_by']:
            
            # Get all mutation names
            mutations = list(details['called_by'].keys())
            mutation_str = ";".join(mutations)

            # Calculate the sum of confidence scores
            current_conf_sum = 0
            for variant_details in details['called_by'].values():
                if 'info' in variant_details and 'conf' in variant_details['info']:
                    # Use .get() for safety, defaulting to 0 if key is missing
                    current_conf_sum += variant_details['info'].get('conf', 0)
            
            total_confidence = current_conf_sum

        # Add the collected data as a dictionary to our list
        output_rows.append({
            'Drug': drug,
            'Prediction': prediction,
            'Mutation': mutation_str,
            'Confidence': total_confidence
        })

    # 4. Create a pandas DataFrame
    # Specify columns to ensure the correct order
    df = pd.DataFrame(output_rows, columns=['Drug', 'Prediction', 'Mutation', 'Confidence'])
    
    # --- ADDED SORTING ---
    # Sort by 'Prediction' column in descending order (R before S)
    df = df.sort_values(by='Prediction', ascending=False)
    
    return df

def main():
    # --- Argument Handling ---
    if len(sys.argv) < 2 or len(sys.argv) > 3:
        print_usage()
        sys.exit(1) # Exit with an error code

    json_filename = sys.argv[1]
    output_format = 'excel' # Default

    if len(sys.argv) == 3:
        if sys.argv[2] == '--csv':
            output_format = 'csv'
        else:
            print_usage()
            sys.exit(1)

    # --- Determine Output Filename ---
    base_name = os.path.splitext(json_filename)[0]
    
    if output_format == 'excel':
        output_filename = f"{base_name}.xlsx"
    else:
        output_filename = f"{base_name}.csv"
        
    # --- Process Data ---
    df = process_mykrobe_json(json_filename)
    
    if df is None:
        # An error already occurred in the processing function
        sys.exit(1)

    # --- Save Output File ---
    try:
        if output_format == 'excel':
            # 'engine='openpyxl'' is needed for .xlsx files
            df.to_excel(output_filename, index=False, engine='openpyxl')
        else:
            df.to_csv(output_filename, index=False)
            
        print(f"✅ Success! Data saved to '{output_filename}'")
        
    except PermissionError:
        print(f"\n❌ Error: Permission denied. Could not write to '{output_filename}'", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"\n❌ Error: Could not save output file. {e}", file=sys.stderr)
        if "No module named 'openpyxl'" in str(e) or (output_format == 'excel' and "Missing optional dependency 'openpyxl'" in str(e)):
            print("❌ Error: The 'openpyxl' library is required to write .xlsx files.", file=sys.stderr)
            print("Please install it manually: pip install openpyxl", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()